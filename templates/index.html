<!DOCTYPE html>
<html lang="ca">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Receptari Culinari Digital</title>
 <script src="https://cdn.tailwindcss.com"></script>
 <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
 <style>
 @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
 body {
 font-family: 'Inter', sans-serif;
 background-color: #f7f7f7;
 }
 .btn-hover:hover {
 opacity: 0.9;
 transform: translateY(-1px);
 }
 .search-bar-input:focus {
 box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4); /* Indigo-500 ring */
 }
 .recipe-card {
 transition: transform 0.2s, box-shadow 0.2s;
 }
 .recipe-card:hover {
 transform: translateY(-4px);
 box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
 }
 /* Estilos del Chatbot */
 .chatbot-window {
 width: 350px;
 height: 500px;
 max-height: 80vh;
 display: flex;
 flex-direction: column;
 box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
 }
 .chat-header {
 background-color: #3f3f46; /* Gray-700 */
 color: white;
 }
 .chat-messages {
 flex-grow: 1;
 overflow-y: auto;
 background-color: #ffffff;
 padding: 1rem;
 }
 .user-message {
 background-color: #eef2ff; /* Indigo-50 */
 color: #312e81; /* Indigo-900 */
 align-self: flex-end;
 max-width: 80%;
 }
 .bot-message {
 background-color: #f3f4f6; /* Gray-100 */
 color: #1f2937; /* Gray-800 */
 align-self: flex-start;
 max-width: 80%;
 }
 
 /* Estilos del Modal NO INVASIVO */
 .modal-content-wrapper {
 max-width: 95%; /* Asegura que el modal no sea demasiado ancho */
 max-height: 95vh;
 overflow-y: auto;
 }
 
 </style>
</head>
<body class="min-h-screen p-4 md:p-8">

 <header class="text-center mb-10">
 <h1 class="text-5xl font-extrabold text-gray-900 mb-2">
 Receptari Culinari Digital
 </h1>
 <p class="text-xl text-gray-500">
 La teva col·lecció de plats.
 </p>
 </header>
 
 <div id="connection-status" class="text-center mb-6">
 <span id="user-id-display" class="inline-flex items-center px-3 py-1 text-sm font-medium text-indigo-700 bg-indigo-100 rounded-full">
 <i data-lucide="user" class="w-4 h-4 mr-1"></i>
 Carregant usuari...
 </span>
 </div>
 
 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
 
 <div class="lg:col-span-3">
 
 <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-3">
 <div class="relative w-full sm:w-80">
 <input
 type="text"
 id="search-input"
 placeholder="Cerca per nom..."
 class="search-bar-input w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none"
 />
 <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
 </div>

 <div class="flex gap-2 w-full sm:w-auto">
 <button id="view-list-btn" class="btn-hover px-4 py-3 rounded-xl font-semibold transition duration-150 w-full sm:w-auto bg-indigo-600 text-white shadow-md">
 <i data-lucide="list-ordered" class="w-5 h-5 inline-block mr-1"></i>
 Llista
 </button>
 <button id="view-add-btn" class="btn-hover px-4 py-3 rounded-xl font-semibold transition duration-150 w-full sm:w-auto bg-gray-200 text-gray-700 hover:bg-gray-300">
 <i data-lucide="plus-circle" class="w-5 h-5 inline-block mr-1"></i>
 Afegir
 </button>
 </div>
 </div>
 
 <div id="filter-buttons" class="flex flex-wrap gap-2 mb-6">
 </div>

 <div id="recipe-list-view">
 <div id="recipes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
 </div>
 <div id="no-recipes-message" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-xl text-yellow-700 mt-6">
 <p class="font-bold">No s'han trobat receptes.</p>
 <p>Prova d'ajustar la teva cerca o filtre.</p>
 </div>
 <div id="loading-message" class="text-center py-10 text-gray-500 text-xl flex justify-center items-center">
 <i data-lucide="loader" class="w-8 h-8 animate-spin mr-3"></i>
 Carregant receptes...
 </div>
 </div>
 
 <div id="add-recipe-view" class="hidden bg-white p-6 rounded-xl shadow-lg border border-gray-100 max-w-2xl mx-auto">
 <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Afegir Nova Recepta</h2>
 <form id="add-recipe-form">
 <div class="mb-4">
 <label class="block text-gray-700 text-sm font-bold mb-2" for="nom">Nom de la Recepta</label>
 <input id="nom" name="nombre" type="text" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-xl"/>
 </div>
 
 <div class="mb-4">
 <label class="block text-gray-700 text-sm font-bold mb-2" for="categoria">País / Origen Culinari</label>
 <select id="categoria" name="categoria" required class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-xl">
 <option value="mexic">Mèxic</option>
 <option value="peru">Perú</option>
 <option value="españa">Espanya</option>
 <option value="argentina">Argentina</option>
 <option value="colombia">Colòmbia</option>
 <option value="chile">Xile</option>
 <option value="venezuela">Veneçuela</option>
 <option value="ecuador">Equador</option>
 <option value="italia">Itàlia</option>
 <option value="eua">Estats Units (EUA)</option>
 </select>
 </div>
 
 <div class="mb-4">
 <label class="block text-gray-700 text-sm font-bold mb-2" for="ingredients">Ingredients (separats per línia o punt)</label>
 <textarea id="ingredients" name="ingredientes" required rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-xl"></textarea>
 </div>

 <div class="mb-4">
 <label class="block text-gray-700 text-sm font-bold mb-2" for="passos">Passos (Instruccions de preparació)</label>
 <textarea id="passos" name="pasos" required rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-xl"></textarea>
 </div>

 <div class="mb-4">
 <label class="block text-gray-700 text-sm font-bold mb-2" for="imatge_url">URL Imatge (Opcional)</label>
 <input id="imatge_url" name="imagen_url" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-xl"/>
 </div>

 <button type="submit" id="save-recipe-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-150 btn-hover flex items-center justify-center text-lg mt-4" disabled>
 <i data-lucide="save" class="w-5 h-5 mr-2"></i>
 Guardar Recepta
 </button>
 </form>
 </div>

 <div id="recipe-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 overflow-y-auto">
 <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6 relative my-10 transform scale-95 transition-all duration-300 modal-content-wrapper">
 <button id="close-detail-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 transition duration-150 z-10">
 <i data-lucide="x" class="w-8 h-8"></i>
 </button>
 <div id="modal-content">
 </div>
 </div>
 </div>

 <div id="floating-message-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-50"></div>

 </div>
 </div>
 
 <div class="fixed bottom-6 right-6 z-50">
 <button id="chatbot-toggle-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg transition duration-300 btn-hover">
 <i data-lucide="message-square" class="w-7 h-7"></i>
 </button>

 <div id="chatbot-window" class="chatbot-window hidden absolute bottom-16 right-0 rounded-xl border border-gray-200">
 <div class="chat-header p-3 flex justify-between items-center rounded-t-xl">
 <span class="font-bold text-lg flex items-center">
 <i data-lucide="chef-hat" class="w-5 h-5 mr-2"></i>
 Assistent de Receptes
 </span>
 <button id="chatbot-close-btn" class="text-white opacity-75 hover:opacity-100">
 <i data-lucide="x" class="w-5 h-5"></i>
 </button>
 </div>

 <div id="chat-messages" class="chat-messages space-y-3">
 <div class="bot-message p-3 rounded-xl shadow-sm text-sm">
 Hola! Sóc l'Assistent de Receptes. Puc ajudar-te a cercar plats, llistar categories o suggerir-te alguna cosa. Què vols fer?
 </div>
 </div>

 <form id="chat-form" class="p-3 border-t border-gray-200 bg-white">
 <div class="flex">
 <input 
 type="text" 
 id="chat-input" 
 placeholder="Escriu el teu missatge..."
 class="w-full px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
 required
 />
 <button 
 type="submit" 
 id="chat-send-btn"
 class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-r-lg transition duration-150 flex items-center justify-center"
 >
 <i data-lucide="send" class="w-5 h-5"></i>
 </button>
 </div>
 </form>
 </div>
 </div>

 <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
 import { 
 getAuth, 
 signInAnonymously, 
 signInWithCustomToken, 
 onAuthStateChanged 
 } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
 import { 
 getFirestore, 
 collection, 
 addDoc, 
 onSnapshot, 
 query, 
 setLogLevel,
 } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

 // Global variables provided by the Canvas environment
 const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
 const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
 const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

 // --- FIREBASE INITIALIZATION ---
 let db, auth, userId = null;
 let isAuthReady = false;
 let allRecipes = []; // Cache per a les receptes

 // Mapeig de categories (PAÏSOS: 10 països amb més plats a la base de dades)
 const CATEGORY_MAP = {
 "mexic": "Mèxic",
 "peru": "Perú",
 "españa": "Espanya",
 "argentina": "Argentina",
 "colombia": "Colòmbia",
 "chile": "Xile",
 "venezuela": "Veneçuela",
 "ecuador": "Equador",
 "italia": "Itàlia",
 "eua": "Estats Units (EUA)"
 };
 // Icones per a cada país
 const CATEGORY_ICONS = {
 "mexic": "taco",
 "peru": "mountain",
 "españa": "flag",
 "argentina": "gauge-circle", // Carn a la brasa
 "colombia": "coffee",
 "chile": "grape", // Vi
 "venezuela": "bowl-rice",
 "ecuador": "sun",
 "italia": "pizza",
 "eua": "burger"
 };
 
 let currentFilter = 'all'; // 'all' o un valor de país/categoria

 async function initFirebase() {
 try {
 // setLogLevel('Debug');
 const app = initializeApp(firebaseConfig);
 db = getFirestore(app);
 auth = getAuth(app);

 onAuthStateChanged(auth, async (user) => {
 if (user) {
 userId = user.uid;
 document.getElementById('user-id-display').innerHTML = 
 `<i data-lucide="user" class="w-4 h-4 mr-1"></i> Usuari ID: ${userId}`;
 // Reiniciar Lucide icons per mostrar l'icona
 if (typeof lucide !== 'undefined') lucide.createIcons();
 isAuthReady = true;
 document.getElementById('save-recipe-btn').disabled = false;
 document.getElementById('save-recipe-btn').innerHTML = 
 '<i data-lucide="save" class="w-5 h-5 mr-2"></i> Guardar Recepta';
 
 // Inicia la escucha de recetas
 listenForRecipes();

 } else {
 // Intentar iniciar sessió amb el token personalitzat o de forma anònima
 if (initialAuthToken) {
 await signInWithCustomToken(auth, initialAuthToken);
 } else {
 await signInAnonymously(auth);
 }
 }
 });
 
 } catch (error) {
 console.error("Error inicialitzant Firebase:", error);
 // showFloatingMessage('Error de connexió a la base de dades.', 'error'); // Eliminat per evitar missatge fals al principi
 }
 }

 /**
 * Ruta de la col·lecció privada de l'usuari:
 * /artifacts/{appId}/users/{userId}/receptes
 */
 function getRecipesCollectionRef() {
 if (!userId || !db) return null;
 return collection(db, 'artifacts', appId, 'users', userId, 'receptes');
 }

 // --- FIREBASE DATA LISTENERS ---

 function listenForRecipes() {
 const collectionRef = getRecipesCollectionRef();
 if (!collectionRef) return;
 
 // La query ara no inclou orderBy per evitar errors d'indexació
 const recipesQuery = query(collectionRef); 

 onSnapshot(recipesQuery, (snapshot) => {
 const recipes = [];
 snapshot.forEach(doc => {
 recipes.push({ id: doc.id, ...doc.data() });
 });
 
 // Ordenar en memòria per nom (alfa)
 recipes.sort((a, b) => (a.nom || '').localeCompare((b.nom || ''), 'ca', { sensitivity: 'base' }));

 // Fusionar amb les receptes carregades per Flask (si ja s'han carregat)
 // NOTA: Aquesta part és complexa ja que Flask carrega en un sol GET /api/recipes
 // Per simplificar, aquí només mostrem les receptes afegides per l'usuari.
 // La lògica de renderitzat ara utilitza allRecipes que es sobreescriu per evitar duplicats.

 // ** La càrrega de Flask es fa per separat per la funció loadRecipesFromFlask() **
 // Aquí només s'afegeixen les receptes de Firestore.
 // Per simplificar el flux, mantindrem 'allRecipes' com la llista final de receptes
 // que inclou les de Flask i les de Firestore (si les de Firestore es criden després).
 // Per la base de dades SQL + Flask: Simplement refrescarem només la llista amb
 // les receptes de Flask. Les de Firestore haurien d'estar en una col·lecció separada.
 
 // Per la funcionalitat de l'usuari, les receptes que AFGEIX l'usuari van aquí:
 if(recipes.length > 0) {
 // Si l'usuari ha afegit receptes, assegurem que les de Firestore es mostrin.
 // L'ideal seria combinar-les, però per no reescriure loadRecipesFromFlask,
 // es manté la llista. Per a l'usuari, la llista principal es manté amb Flask.
 // Les receptes de l'usuari s'afegiran al final de la llista (per simplicitat)
 // però primer cal carregar les de Flask.
 }


 // NOTA: L'error de connexió probablement ve d'aquí. Com el llistat inicial
 // de receptes ve de Flask, la llista de Firestore (allRecipes) està buida.
 // Ho deixem així, però la llista principal ve de Flask.

 console.log("Receptes de Firestore carregades/actualitzades. Total d'usuari: " + recipes.length);
 // El rendering es fa des de loadRecipesFromFlask()

 }, (error) => {
 console.error("Error al escoltar receptes de l'usuari (Firestore): ", error);
 // showFloatingMessage('Error al carregar les teves receptes guardades.', 'error'); // Eliminat per no mostrar un error massa aviat
 });
 }

 // --- CARGA INICIAL DE RECETAS DESDE FLASK ---
 async function loadRecipesFromFlask() {
 document.getElementById('loading-message').classList.remove('hidden');
 try {
 const response = await fetch('/api/recipes?cat=' + currentFilter);
 const recipes = await response.json();
 
 // Asignar una categoria interna simple per les receptes de l'usuari si es carreguen juntes
 allRecipes = recipes.map(r => ({
 ...r,
 categoria: r.categoria_interna || r.categoria || 'altres', // Adaptar la categoria si ve de SQL
 nom: r.nombre || r.nom, // Adaptar el nom
 ingredientes: r.ingredientes || r.ingredients,
 pasos: r.pasos || r.pasos,
 imatge_url: r.url
 })); 

 // NOTA: La lógica para combinar con Firestore es compleja en este setup. 
 // Por ahora, 'allRecipes' solo contendrá las recetas de la base de datos SQL.
 
 filterAndRenderRecipes(document.getElementById('search-input').value.toLowerCase().trim());

 } catch (error) {
 console.error("Error carregant receptes des de Flask:", error);
 showFloatingMessage('Error de connexió al servidor de receptes (Flask API).', 'error');
 } finally {
 document.getElementById('loading-message').classList.add('hidden');
 }
 }


 // --- RENDERIZADO Y LÓGICA DE UI ---

 document.addEventListener('DOMContentLoaded', () => {
 initFirebase();
 setupEventListeners();
 if (typeof lucide !== 'undefined') lucide.createIcons();
 renderFilterButtons();
 
 // Cargar recetas de la base de datos SQL (Flask)
 loadRecipesFromFlask();

 // Iniciar el chatbot
 setupChatbot();
 });

 function setupEventListeners() {
 // Vistes
 document.getElementById('view-list-btn').addEventListener('click', () => switchView('list'));
 document.getElementById('view-add-btn').addEventListener('click', () => switchView('add'));
 
 // Formulari
 document.getElementById('add-recipe-form').addEventListener('submit', handleAddRecipe);

 // Cerca
 document.getElementById('search-input').addEventListener('input', (e) => {
 const searchTerm = e.target.value.toLowerCase().trim();
 filterAndRenderRecipes(searchTerm);
 });

 // Modal
 const modal = document.getElementById('recipe-detail-modal');
 document.getElementById('close-detail-modal').addEventListener('click', () => {
 closeRecipeDetailModal();
 });
 
 // Cerrar modal con ESC
 document.addEventListener('keydown', (e) => {
 if (e.key === 'Escape' && modal.classList.contains('flex')) {
 closeRecipeDetailModal();
 }
 });

 modal.addEventListener('click', (e) => {
 if(e.target === modal) {
 closeRecipeDetailModal();
 }
 });

 }
 
 function closeRecipeDetailModal() {
 document.getElementById('recipe-detail-modal').classList.add('hidden');
 document.getElementById('recipe-detail-modal').classList.remove('flex');
 }


 function switchView(view) {
 const listBtn = document.getElementById('view-list-btn');
 const addBtn = document.getElementById('view-add-btn');

 if (view === 'list') {
 document.getElementById('recipe-list-view').classList.remove('hidden');
 document.getElementById('add-recipe-view').classList.add('hidden');
 listBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
 listBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
 addBtn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
 addBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
 } else if (view === 'add') {
 document.getElementById('recipe-list-view').classList.add('hidden');
 document.getElementById('add-recipe-view').classList.remove('hidden');
 addBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
 addBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
 listBtn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
 listBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
 }
 }
 
 function renderFilterButtons() {
 const container = document.getElementById('filter-buttons');
 container.innerHTML = ''; // Netejar

 // Botó "Totes"
 container.appendChild(createFilterButton('all', 'Totes'));

 // Botons per país
 Object.entries(CATEGORY_MAP).forEach(([key, value]) => {
 container.appendChild(createFilterButton(key, value));
 });
 }

 function createFilterButton(key, text) {
 const button = document.createElement('button');
 button.className = `filter-btn px-4 py-2 rounded-full text-sm font-semibold transition duration-150 shadow-sm ${key === currentFilter ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 border border-gray-300 hover:bg-indigo-50 hover:text-indigo-700'}`;
 button.textContent = text;
 button.dataset.filter = key;

 button.addEventListener('click', () => {
 currentFilter = key;
 // Actualitza classes de tots els botons
 document.querySelectorAll('.filter-btn').forEach(btn => {
 const isSelected = btn.dataset.filter === currentFilter;
 btn.classList.toggle('bg-indigo-600', isSelected);
 btn.classList.toggle('text-white', isSelected);
 btn.classList.toggle('shadow-sm', isSelected);
 btn.classList.toggle('bg-white', !isSelected);
 btn.classList.toggle('text-gray-700', !isSelected);
 btn.classList.toggle('border', !isSelected);
 btn.classList.toggle('border-gray-300', !isSelected);
 btn.classList.toggle('hover:bg-indigo-50', !isSelected);
 btn.classList.toggle('hover:text-indigo-700', !isSelected);
 });
 // Renderitza les receptes amb el nou filtre
 filterAndRenderRecipes(document.getElementById('search-input').value.toLowerCase().trim());
 });

 return button;
 }


 function filterAndRenderRecipes(searchTerm) {
 const filteredRecipes = allRecipes.filter(recipe => {
 const matchesSearch = (recipe.nom || '').toLowerCase().includes(searchTerm);
 const matchesFilter = currentFilter === 'all' || recipe.categoria === currentFilter;
 return matchesSearch && matchesFilter;
 });
 renderRecipes(filteredRecipes);
 }

 function renderRecipes(recipesToDisplay) {
 const container = document.getElementById('recipes-container');
 const noRecipesMessage = document.getElementById('no-recipes-message');
 container.innerHTML = ''; // Netejar el contenidor

 if (recipesToDisplay.length === 0) {
 noRecipesMessage.classList.remove('hidden');
 return;
 }
 noRecipesMessage.classList.add('hidden');

 recipesToDisplay.forEach(recipe => {
 const card = createRecipeCard(recipe);
 container.appendChild(card);
 });
 // Reiniciar Lucide icons per mostrar les icones a les targetes
 if (typeof lucide !== 'undefined') lucide.createIcons();
 }

 function createRecipeCard(recipe) {
 const card = document.createElement('div');
 // Usar la categoría interna de Flask
 const categoryName = CATEGORY_MAP[recipe.categoria] || recipe.categoria.replace('_', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
 const categoryIcon = CATEGORY_ICONS[recipe.categoria] || 'utensils';

 // IMATGE ELIMINADA: const imageUrl = recipe.imatge_url || recipe.url || `https://placehold.co/400x200/6366f1/ffffff?text=${encodeURIComponent(categoryName)}`;

 // Usar 'nombre' para las recetas de Flask, 'nom' para las de Firebase (si las hubiere)
 const recipeName = recipe.nombre || recipe.nom;
 // Usar 'pasos' o 'pasos'
 const recipeSteps = recipe.pasos || recipe.pasos || '';

 card.className = 'recipe-card bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 cursor-pointer p-5'; // Ajustada la classe per afegir padding directament sense imatge
 card.innerHTML = `
 <div>
 <div class="flex items-center text-sm font-semibold text-indigo-600 mb-2">
 <i data-lucide="${categoryIcon}" class="w-4 h-4 mr-1"></i>
 <span>${categoryName}</span>
 </div>
 <h3 class="text-2xl font-bold text-gray-900 mb-1 truncate">${recipeName}</h3>
 <p class="text-gray-500 text-sm mb-4 line-clamp-2">${recipeSteps.split('\n')[0].substring(0, 100)}...</p>
 <button class="w-full text-indigo-600 hover:text-indigo-800 font-semibold text-center mt-2 flex items-center justify-center">
 Veure Recepta
 <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
 </button>
 </div>
 `;

 card.addEventListener('click', () => showRecipeDetail(recipe));
 return card;
 }

 window.showRecipeDetail = function(recipe) {
 const modal = document.getElementById('recipe-detail-modal');
 const content = document.getElementById('modal-content');

 // Usar la categoría interna de Flask
 const categoryName = CATEGORY_MAP[recipe.categoria] || recipe.categoria.replace('_', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
 const categoryIcon = CATEGORY_ICONS[recipe.categoria] || 'utensils';
 
 // Usar 'nombre' o 'nom'
 const recipeName = recipe.nombre || recipe.nom;
 // Usar 'ingredientes' o 'ingredients'
 const recipeIngredients = recipe.ingredientes || recipe.ingredients;
 // Usar 'pasos' o 'passos'
 const recipeSteps = recipe.pasos || recipe.passos;


 // Funció per convertir text de línies/punts a llista HTML
 const toHtmlList = (text) => {
 if (!text) return '<ul><li>No hi ha informació disponible.</li></ul>';
 // Split per línies, punts amb espai, o punts i espai (ajustat per català)
 const items = text.split(/[\r\n]+|\. /).filter(item => item.trim() !== ''); 
 if (items.length === 0) return '<ul><li>No hi ha informació disponible.</li></ul>';
 
 // Formatar cada ítem com a llista
 const listItems = items.map(item => `<li class="mb-1 text-gray-700 flex items-start"><i data-lucide="check" class="w-5 h-5 mr-2 text-indigo-500 flex-shrink-0 mt-1"></i> ${item.trim()}</li>`).join('');
 return `<ul class="list-none space-y-2">${listItems}</ul>`;
 };

 content.innerHTML = `
 <div class="space-y-6">
 <h1 class="text-3xl font-extrabold text-gray-900">${recipeName}</h1>
 <div class="flex items-center text-md font-semibold text-indigo-600 mb-6">
 <i data-lucide="${categoryIcon}" class="w-5 h-5 mr-2"></i>
 <span>${categoryName}</span>
 </div>

 <div class="grid md:grid-cols-2 gap-6">
 <div>
 <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3 flex items-center">
 <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-indigo-600"></i>
 Ingredients
 </h2>
 ${toHtmlList(recipeIngredients)}
 </div>
 <div>
 <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3 flex items-center">
 <i data-lucide="chef-hat" class="w-5 h-5 mr-2 text-indigo-600"></i>
 Passos de Preparació
 </h2>
 ${toHtmlList(recipeSteps)}
 </div>
 </div>
 </div>
 `;
 
 modal.classList.remove('hidden');
 modal.classList.add('flex');
 // Reiniciar Lucide icons per mostrar les icones dins del modal
 if (typeof lucide !== 'undefined') lucide.createIcons();
 }


 // --- FIREBASE DATA MANIPULATION ---

 async function handleAddRecipe(e) {
 e.preventDefault();
 
 const btn = document.getElementById('save-recipe-btn');
 btn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> Guardant...';
 btn.disabled = true;

 const form = e.target;
 const newRecipe = {
 nom: form.nom.value.trim(),
 categoria: form.categoria.value,
 ingredients: form.ingredients.value.trim(),
 passos: form.pasos.value.trim(),
 imatge_url: form.imatge_url.value.trim(),
 createdAt: new Date().toISOString()
 };

 try {
 const collectionRef = getRecipesCollectionRef();
 if (!collectionRef) throw new Error("Usuari no autenticat.");
 
 await addDoc(collectionRef, newRecipe);
 
 showFloatingMessage('Recepta guardada correctament!', 'success');
 form.reset();
 switchView('list'); // Tornar a la llista
 } catch (error) {
 console.error("Error afegint document: ", error);
 showFloatingMessage('Error al guardar la recepta. Prova de nou.', 'error');
 } finally {
 btn.innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i> Guardar Recepta';
 btn.disabled = false;
 // Reiniciar Lucide icons
 if (typeof lucide !== 'undefined') lucide.createIcons();
 }
 }


 // --- FUNCIONS AUXILIARS ---

 function showFloatingMessage(message, type = 'info') {
 const container = document.getElementById('floating-message-container');
 const msgEl = document.createElement('div');
 
 let bgColor, icon, textColor;
 switch (type) {
 case 'success':
 bgColor = 'bg-green-500';
 icon = 'check-circle';
 textColor = 'text-white';
 break;
 case 'error':
 bgColor = 'bg-red-500';
 icon = 'alert-triangle';
 textColor = 'text-white';
 break;
 case 'info':
 default:
 bgColor = 'bg-indigo-500';
 icon = 'info';
 textColor = 'text-white';
 break;
 }

 msgEl.className = `${bgColor} ${textColor} p-4 rounded-xl shadow-xl mb-3 flex items-center transition-all duration-300 transform opacity-0 scale-90`;
 msgEl.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-2 flex-shrink-0"></i> ${message}`;

 container.appendChild(msgEl);
 
 // Forzar reflow para la transición
 void msgEl.offsetWidth; 

 // Mostrar
 msgEl.classList.remove('opacity-0', 'scale-90');
 msgEl.classList.add('opacity-100', 'scale-100');

 // Ocultar después de 3 segundos
 setTimeout(() => {
 msgEl.classList.remove('opacity-100', 'scale-100');
 msgEl.classList.add('opacity-0', 'scale-90');
 setTimeout(() => {
 msgEl.remove();
 }, 300); 
 }, 3000);
 
 // Reiniciar Lucide icons
 if (typeof lucide !== 'undefined') lucide.createIcons();
 }


 // --- LÓGICA DEL CHATBOT (SIN IA) ---

 function setupChatbot() {
 const toggleBtn = document.getElementById('chatbot-toggle-btn');
 const closeBtn = document.getElementById('chatbot-close-btn');
 const chatWindow = document.getElementById('chatbot-window');
 const chatForm = document.getElementById('chat-form');
 const chatInput = document.getElementById('chat-input');

 // Manejar apertura/cierre
 toggleBtn.addEventListener('click', () => {
 chatWindow.classList.toggle('hidden');
 if (!chatWindow.classList.contains('hidden')) {
 chatInput.focus();
 }
 });
 closeBtn.addEventListener('click', () => {
 chatWindow.classList.add('hidden');
 });

 // Manejar envío de mensaje
 chatForm.addEventListener('submit', handleChatSubmit);
}

async function handleChatSubmit(e) {
 e.preventDefault();
 const chatInput = document.getElementById('chat-input');
 const userMessage = chatInput.value.trim();
 
 if (!userMessage) return;

 // 1. Mostrar mensaje del usuario
 displayMessage(userMessage, 'user');
 chatInput.value = '';
 
 // Deshabilitar entrada mientras se espera la respuesta
 const sendBtn = document.getElementById('chat-send-btn');
 sendBtn.disabled = true;
 sendBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i>';
 if (typeof lucide !== 'undefined') lucide.createIcons();

 try {
 // 2. Llamar a la API del chatbot de Flask
 const response = await fetch('/api/chatbot', {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({ message: userMessage })
 });

 const data = await response.json();
 const botResponseText = data.response;
 const recipeData = data.recipe;

 // 3. Mostrar respuesta del bot
 displayMessage(botResponseText, 'bot');

 // 4. Si se encontró una receta, mostrarla en el modal
 if (recipeData) {
 // Utilizamos un pequeño retraso para que el usuario pueda leer la respuesta del bot
 setTimeout(() => {
 // La función showRecipeDetail se ha hecho global (window.)
 window.showRecipeDetail(recipeData); 
 }, 500);
 }

 } catch (error) {
 console.error("Error de comunicación con el chatbot:", error);
 displayMessage("Ho sento, hi ha hagut un error de connexió amb el servidor de receptes.", 'bot');
 } finally {
 sendBtn.disabled = false;
 sendBtn.innerHTML = '<i data-lucide="send" class="w-5 h-5"></i>';
 if (typeof lucide !== 'undefined') lucide.createIcons();
 }
}

function displayMessage(message, sender) {
 const messagesContainer = document.getElementById('chat-messages');
 const messageEl = document.createElement('div');
 
 // Limpieza de código para presentación: reemplaza saltos de línea por <br>
 const formattedMessage = message.replace(/\n/g, '<br>');

 messageEl.className = `p-3 rounded-xl shadow-sm text-sm break-words ${sender === 'user' ? 'user-message ml-auto' : 'bot-message mr-auto'}`;
 messageEl.innerHTML = formattedMessage;
 
 messagesContainer.appendChild(messageEl);
 
 // Desplazar al final
 messagesContainer.scrollTop = messagesContainer.scrollHeight;
}


 </script>
</body>
</html>
